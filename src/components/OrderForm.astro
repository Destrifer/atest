---
// Form.astro
const { vehicle } = Astro.props;
---

<form id="apiForm">
	<label>
		Телефон:
		<input type="text" name="phone" value="+79099999009" required />
	</label>
	<br />
	<label>
		Имя:
		<input type="text" name="name" value="Тест" required />
	</label>
	<br />
	<label>
		Фамилия:
		<input type="text" name="surname" value="Тест" required />
	</label>
	<br />
	<label>
		Email:
		<input type="email" name="email" value="test@test.com" required />
	</label>
	<br />
	<label>
		Дата и время начала:
		<input
			type="datetime-local"
			name="pick_up_datetime"
			value="2024-12-14T12:00"
			required
		/>
	</label>
	<br />
	<label>
		Дата и время завершения:
		<input
			type="datetime-local"
			name="drop_off_datetime"
			value="2024-12-21T10:00"
			required
		/>
	</label>
	<br />
	<label>
		Стоимость за день:
		<input type="number" name="cost_per_day" value="1000" required />
	</label>
	<br />
	<label>
		ID пункта выдачи:
		<input type="number" name="pick_up_location_id" value="82" required />
	</label>
	<br />
	<label>
		ID пункта возврата:
		<input type="number" name="drop_off_location_id" value="82" required />
	</label>
	<br />
	<label>
		Итоговая стоимость:
		<input type="number" name="cost_total" value="999" required />
	</label>
	<br />
	<input type="hidden" name="vendor_vehicle_id" value={vehicle.data.id} />
	<input type="hidden" name="vehicle_model" value={vehicle.data.model} />
	<input
		type="hidden"
		name="vehicle_engine_type"
		value={vehicle.data.engine_type}
	/>
	<input
		type="hidden"
		name="vehicle_engine_hp"
		value={vehicle.data.engine_hp}
	/>
	<input
		type="hidden"
		name="vehicle_engine_capacity"
		value={vehicle.data.engine_capacity}
	/>
	<input
		type="hidden"
		name="vehicle_transmission"
		value={vehicle.data.transmission}
	/>
	<input
		type="hidden"
		name="vehicle_engine_hp"
		value={vehicle.data.engine_hp}
	/>
	<input type="hidden" name="vehicle_year" value={vehicle.data.year} />
	<input
		type="hidden"
		name="vehicle_rent_period_days"
		value={vehicle.data.rent_period_days}
	/>
	<input
		type="hidden"
		name="vehicle_images"
		value={vehicle.data.images[0].thumbnail}
	/>
	<button type="button" id="submitButton">Отправить</button>
</form>
<script>
	document
		.getElementById("submitButton")
		.addEventListener("click", async () => {
			const form = document.getElementById("apiForm");
			if (!(form instanceof HTMLFormElement)) {
				console.error("Элемент формы не найден или имеет неверный тип.");
				return;
			}
			const formData = new FormData(form);

			// Функция для преобразования даты и времени в формат DD.MM.YYYY HH:mm
			const formatDateTime = (dateTime) => {
				const [date, time] = dateTime.split("T");
				const [year, month, day] = date.split("-");
				return `${day}.${month}.${year} ${time}`;
			};

			const data = {
				accept: "1",
				data: {
					phone: formData.get("phone"),
					name: formData.get("name"),
					surname: formData.get("surname"),
					email: formData.get("email"),
					pick_up_datetime: formatDateTime(formData.get("pick_up_datetime")),
					drop_off_datetime: formatDateTime(formData.get("drop_off_datetime")),
					vendor_vehicle_id: formData.get("vendor_vehicle_id"),
					cost_per_day: Number(formData.get("cost_per_day")),
					pick_up_location_id: Number(formData.get("pick_up_location_id")),
					drop_off_location_id: Number(formData.get("drop_off_location_id")),
					currency: {
						id: 1,
						letter_code: "RUB",
					},
					cost_total: Number(formData.get("cost_total")),
				},
				full_data: JSON.stringify({
					info: {
						pick_up_location_id: Number(formData.get("pick_up_location_id")),
						drop_off_location_id: Number(formData.get("drop_off_location_id")),
					},
					extras: {},
					vehicle: {
						model: formData.get("vehicle_model"),
						engine_type: formData.get("vehicle_engine_type"),
						engine_hp: formData.get("vehicle_engine_hp"),
						engine_capacity: formData.get("vehicle_engine_capacity"),
						transmission: formData.get("vehicle_transmission"),
						year: formData.get("vehicle_year"),
						rent_period_days: formData.get("vehicle_rent_period_days"),
						images: [
							{
								thumbnail: formData.get("vehicle_images"),
							},
						],
					},
					equipment: {},
				}),
			};

			// Выводим преобразованные значения в консоль
			console.log("Formatted pick_up_datetime:", data.data.pick_up_datetime);
			console.log("Formatted drop_off_datetime:", data.data.drop_off_datetime);

			try {
				const response = await fetch(
					"https://mycarrental.ru/api/v1/order/store",
					{
						method: "POST",
						headers: {
							"Content-Type": "application/json",
							Authorization: "Bearer ILup4Hh8B7degUc01nHx6js5",
						},
						body: JSON.stringify(data),
					},
				);

				if (!response.ok) {
					throw new Error(`Ошибка: ${response.status} ${response.statusText}`);
				}

				const result = await response.json();
				console.log("Response:", result);
				alert("Заказ успешно отправлен!");
			} catch (error) {
				console.error("Error:", error.message);
				alert("Ошибка при отправке заказа: " + error.message);
			}
		});
</script>
