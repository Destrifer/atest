---
import Layout from "../../layouts/Layout.astro";
import { Icon } from "astro-icon/components";
import OrderForm from "@components/OrderForm.astro";
import { formatDateForAPI } from "../../utils/utils";

const { id } = Astro.params;
const url = new URL(Astro.request.url);

// Дефолтные параметры для API
const fromId = url.searchParams.get("from-id") || "10";
const toId = url.searchParams.get("to-id") || "10";
const fromDate = url.searchParams.get("from-date") || "2024-12-20";
const toDate = url.searchParams.get("to-date") || "2024-12-28";
const promocode = url.searchParams.get("promocode") || "";

// Запрос данных из API
const apiUrl = `https://new.mycarrental.ru/api/v2/search_cars?from-id=${fromId}&to-id=${toId}&from-date=${fromDate}&to-date=${toDate}&from-time=12%3A00&to-time=12%3A00&promocode=${promocode}`;
console.log(apiUrl);
let vehicle;

try {
	const response = await fetch(apiUrl);

	if (!response.ok) {
		throw new Error("Не удалось загрузить данные автомобиля.");
	}

	const data = await response.json();
	vehicle = data.vehicles.find((v) => v.id === id);

	if (!vehicle) {
		throw new Error("Автомобиль с указанным ID не найден.");
	}
} catch (error) {
	console.error("Ошибка:", error.message);
	throw new Error("Ошибка загрузки данных автомобиля.");
}

// SEO
const h1 = `${vehicle.model} - Прокат автомобиля в Крыму`;
const title = `Аренда авто ${vehicle.model} в Крыму Car on Time`;
const description = `Взять напрокат автомобиль ${vehicle.model}, Крым компания CAR ON TIME. Аренда - это удобный вариант передвижения по Крыму.`;
---

<Layout title={title} description={description} h1={h1}>
	<div class="container mx-auto grid gap-4 p-4">
		<!-- Основной блок с галереей -->
		<div class="flex flex-wrap 2xl:flex-nowrap m-2 gap-4">
			<div class="embla">
				<div class="embla__viewport">
					<div class="embla__container">
						<div class="embla__slide">
							<img
								src={vehicle.images[0]?.image}
								alt={`Изображение ${vehicle.model}`}
							/>
						</div>
						{
							vehicle.real_photos?.map((photo) => (
								<div class="embla__slide">
									<img
										src={photo.replace("_w200", "")}
										alt="Реальное фото автомобиля"
									/>
								</div>
							))
						}
					</div>
				</div>
				<button
					class="embla__button embla__button--prev"
					aria-label="Предыдущий слайд"
				>
					<span class="embla__icon"></span>
				</button>
				<button
					class="embla__button embla__button--next"
					aria-label="Следующий слайд"
				>
					<span class="embla__icon"></span>
				</button>
			</div>
			<div>
				<OrderForm
					vehicle={vehicle}
					fromDate={fromDate}
					toDate={toDate}
					fromId={fromId}
					toId={toId}
				/>
			</div>
		</div>

		<!-- Характеристики автомобиля -->
		<ul class="car-details grid grid-cols-1 md:grid-cols-2 gap-4">
			<li><strong>Класс:</strong> {vehicle.class_id}</li>
			<li><strong>Год выпуска:</strong> {vehicle.year}</li>
			<li><strong>Двигатель:</strong> {vehicle.engine_capacity}</li>
			<li><strong>Коробка передач:</strong> {vehicle.transmission}</li>
			<li><strong>Топливо:</strong> {vehicle.engine_type}</li>
			<li><strong>Мест:</strong> {vehicle.seats}</li>
			<li><strong>Цвет:</strong> {vehicle.color}</li>
			<li><strong>Депозит:</strong> {vehicle.deposit} ₽</li>
			<li>
				<strong>Стоимость аренды за сутки:</strong>
				{vehicle.rate_per_day} ₽
			</li>
		</ul>

		<!-- Дополнительные услуги -->
		<div class="additional-services">
			<h2 class="py-4 font-black text-xl uppercase">Дополнительные услуги:</h2>
			<ul>
				<li>Навигатор: 150 ₽ в сутки</li>
				<li>Детское кресло: 200 ₽ в сутки</li>
				<li>Wi-Fi Интернет: 300 ₽ в сутки</li>
				<li>Мойка кузова автомобиля: 500 ₽</li>
			</ul>
		</div>
	</div>

	<!-- Стандартный текст с условиями -->
	<div class="conditions">
		<h2 class="py-4 font-black text-xl uppercase">Условия аренды:</h2>
		<p>Возраст: с 22 лет</p>
		<p>Стаж: от 3 лет</p>
		<p>Залог: от 5 000 ₽</p>
	</div>
</Layout>

<style>
	.car-details li {
		border-bottom: 1px solid #ddd;
		padding: 8px 0;
	}

	.embla__button {
		position: absolute;
		top: 50%;
		transform: translateY(-50%);
		width: 3rem;
		height: 3rem;
		background: rgba(0, 0, 0, 0.5);
		color: white;
		border: none;
		cursor: pointer;
		border-radius: 50%;
	}

	.embla__button--prev {
		left: 1rem;
	}

	.embla__button--next {
		right: 1rem;
	}
</style>

<script>
	document.addEventListener("DOMContentLoaded", async () => {
		const EmblaCarousel = (await import("embla-carousel")).default;
		const emblaNode = document.querySelector(".embla__viewport");
		const embla = EmblaCarousel(emblaNode, { loop: true });
		document
			.querySelector(".embla__button--prev")
			.addEventListener("click", () => embla.scrollPrev());
		document
			.querySelector(".embla__button--next")
			.addEventListener("click", () => embla.scrollNext());
	});
</script>
